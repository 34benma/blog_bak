---
title: '深入理解原子性与可见性'
date: 2016-10-21 19:24:36
tags:
 - 并发编程
 - 原子性
 - 可见性
categories: 深入理解
---
在并发编程的世界里，有两个非常重要的关键字，分别是synchronized和volatile. 一句话概括这两个关键字的作用的话就是synchronized保证了原子性，volatile保证了可见性。本文将深入分析原子性和可见性。

<!--more-->

<h2>原子性</h2>

所谓原子性就是指操作不可分解，不会出现一半成功，一半失败的情况。我们都知道事务具有ACID属性，其中的A就是原子性。事务中的原子性也是说一个完整的事务中定义的全部操作步骤要么全部成功，要么全部不成功，不可分解。和我们这里的原子性定义是一样的。在并发编程中，我们在临界区的某些操作，必须具有原子性。因为我们无法控制线程的切换，所以就有可能发生线程执行到某个中间位置，因为时间片或者等待资源的情况发了上下文切换，切入到另外一个线程，这时候就破坏了数据的一致性。因此，我们必须保证临界区中这些操作的原子性。

<h3>保证原子性的手段</h3>

保证原子性的手段之一就是加锁。所谓锁，我们可以这么理解，当我们某个线程获取了锁，就代表他获得了一个特殊通行证，并且这个通行证一定是唯一的。在它归还这个通行证之前，其他线程是没办法进入到锁区域的。自然其他线程也就无法看到锁区域中数据的状态，也不能修改其状态。因此，只要我们的线程没有释放锁，其他线程是无法进入到锁区域的。直到我们成功释放了锁，我们的操作都是原子性的，不会被其他线程所干扰。

加锁的第一种方式是synchronized，这是Java提供的一个关键字，这个关键字的含义就是内置锁或者监视器锁。当我们的线程进入到了synchronized区域时，自动会获取锁，当退出这个区域是自动释放锁。如果我们使用javap打印一下一个synchronized修饰的代码块，我们会发现，有个叫**enter monitor**和**exit monitor**的两条指令，它们所包围的指令就是使用synchronized修饰的区域。

在J.U.C里，提供了更加灵活的加锁机制，就是Lock类，这是从Java代码层面提供的锁机制。这套机制比synchronized更加灵活，而且从JDK 1.6之后，这套锁机制的性能比synchronized更好了。这里面将锁划分的更细，可以有互斥锁(写锁)和共享锁(读锁)。获取锁和释放锁的操作都是可控的了，因此更加灵活，但是带来的使用复杂性也更加高了，如果我们获取了锁忘记释放锁或者释放锁失败将有可能会造成死锁等。

当我们看过J.U.C实现锁的方式(基于AQS)，我们自己也可以实现锁。如果使用Semaphore类的话，自己实现锁就更加简单了。

当然，保证原子性的手段并不是只有加锁这一种。事实上，锁机制对指令执行性能是有影响的。因此，如果不是有必要，我们不要随便加锁，而且加锁的区域尽量保证最小化，不要将没有必要加锁的代码放到锁区域中来。

原子性的另外一种方式是无锁化。这个看起来比较矛盾，其实是不矛盾的。无锁化是通过CAS(Compare and set)来实现的。J.U.C中提供了一些原子类，它保证原子性的方式就是CAS。后续我们分析J.U.C的原子类时将详细讲解CAS操作。

两种实现原子性的方式并不是可以互相替代的，而是他们在特定的场景具有特定的使用方式。加锁一般是代码块。而无锁化则是一些需要原子化的变量，通过CAS比使用加锁在变量层面性能更高。

<h2>可见性</h2>

所谓可见性是指我们希望对于某些状态我们进行了修改，希望其他线程能够感知到。这里就有线程通信的意思在里面了。考虑这样一种场景，变量x是两个线程A,B都可以看到的，线程A，B都保存了一份副本在彼此的栈帧里，当线程A修改了x时，如果没有一种机制去通信告知线程B，线程B仍然使用的是旧的x值。因此可见性就是要保证线程B能及时感知到x的状态变化。同样在CPU层面，也有这种场景，比如多核多寄存器。同样有变量的缓存以及修改需要通知其他CPU或寄存器变量的修改。当然这个层面不是JVM来保证了。

<h3>保证可见性的手段</h3>

保证可见性的第一种方法是直接使用锁，从效果上是可以的。但是前文说过，锁的方式对性能影响比较大。因此Java提供了另外一个关键字叫做volatile。这个关键字就是用来保证可见性的，它还有一个别称叫“轻量级锁”。

volatile为什么可以保证可见性呢? 这里可以从JMM找到原理。在下一篇讲解JMM时我们将详细分析synchronized和volatile两个关键字的原理。

<h2>总结</h2>

原子性和可见性是并发编程里两个非常重要的基础概念，只有深入理解了这两个概念，我们才能用好锁，用好可见性。才能编写出性能优越，线程安全的代码来。

[专题目录](http://wantedonline.cn/2016/09/08/20160908-1/)
