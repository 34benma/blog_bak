---
title: '理解Java内存模型(JMM)'
date: 2016-10-29 15:43:57
tags: 
 - JMM
 - 并发编程
 - Java内存模型
categories: 深入理解
---
当对并发编程的学习从初级阶段进入到高级阶段的过程中，对Java内存模型(JMM)的理解我认为是一个重要的分水岭。只有真正理解了JMM，才可能对并发中的线程、同步、线程通信以及后续并发编程高级技巧以及性能优化等问题有所理解。本文将总结我对JMM的一些理解。当然如果需要真正深入理解透彻JMM，还是需要读一读参考文献中的链接。
 
 <!--more-->
 
 <h2>1 什么是Java内存模型</h2>
 
 Java内存模型(JMM)不是Java语言所特有的。事实上像C#,Go等也有所谓的内存模型。这几门语言的内存模型总的来说要目标是一致的，但是可能语言之间的一些细节是有所差别的。**Java内存模型要解决的一个问题是多线程中线程私有内存和主内存之间的数据一致性以及数据通信问题,这里需要重点说明的是这里主内存不是堆内存，这里的主内存是个抽象概念，并不对应JVM或者操作系统某块内存。**事实上，不仅仅是JVM存在这个问题，在多处理器多寄存器架构中，也一定存在这个问题。考虑这样一种场景：多CPU，多寄存器通过总线共享主内存。如果在多线程环境下，CPU1中线程甲对数据A进行了修改操作，这时候CPU2中线程乙需要读取数据A。数据A分别在CPU1和CPU2的寄存器中存在副本。如果没有一种机制来保证数据通信，就一定会有数据一致性问题。JVM中，线程的一些数据是存在线程栈帧中的，多线程环境下，如何保证某些需要共享的数据的一致性和通信问题就需要一种机制来保证。因此才有了Java内存模型，对Java内存模型的定义以及一些规范是在JSR-133。
 
 <h2>2 Java内存模型中几个重要概念</h2>
 
 Java内存模型中比较重要的也就是下面的三个概念了。这几个概念的最直观体现就是对synchonized,volatile,final,static等一些关键字的合理使用所带来的效果了。
 
 <h3>重排序</h3>
 
 关于重排序在上一篇文章中也有所提到。重排序有三个层次，分别是编译器的重排序，操作系统的重排序以及CPU指令级别的重排序。之所以会有重排序，是因为我们的编译器，操作系统，CPU已经很智能化了，它能够在不影响语义的情况下对某些指令进行优化以及调整顺序，以此来达到性能优化，减少一些不必要的指令执行的目的。但是在多线程环境下，重排序会导致数据一致性问题。因此才需要一些必要的保证手段来防止这三个层次的重排序。比如synchonized，volatile等。
 
 <h3>内存屏障</h3>
 
 内存屏障这个概念事实上以及是指令级别了。它规定了某些操作的先后顺序以及可见性问题。比如多处理环境下，对某些指令的执行必须要先于其他指令，可能就需要一个loadload指令等等。内存屏障的种类也有很多，比如loadload，loadstore，storestore等。不同的屏障功能不一样，适用场景也不一样。这一点对上层程序员是透明的。因此我觉得了解即可。
 
 <h3>Happen-Before</h3>
 
 Happen-Before是JMM所定义的一些规则。这些规则保证了一些操作的顺序问题。这些顺序是有JVM来保证，并且保证不会被编译器或CPU等重排序所打破。Happen-Before也是定义的一个顺序问题。但是和内存屏障相比，它不再是指令级别，而是一个概念级别。或者一个原则问题。因此，有的书上也直接把这个叫做Happen-Before原则。具体的Happen-Before原则有这儿几条：
 
   - 程序顺序规则：一个线程中的每个操作，happen-before与该线程的后续操作
   - 监视器锁规则：对一个监视器锁的解锁，happen-before于随后对这个监视器锁的加锁
   - volatile变量规则:对一个volatile域的写，happen-before于任意后续对这个volatile域的读
   - 传递性：如果A happen-before B，B happen-before C，那么A happen-before C
   - Thread.start()的调用happen-before于启动线程里面的动作
   - Thread中的所有动作都happen-before于其他线程从Thread.join中成功返回
 
 <h2>3 Java内存模型对并发编程的意义</h2>
 
 JSR-133还定义了final，static等关键字的一些详细含义。因此如果要理解JMM，势必是要读一读JSR-133的。理解JMM，对于并发编程的最大意义我认为是在于对synchonized，volatile，fianl,static等关键字的合理运用，编写性能更好的并发程序来。
 
 <h3>参考文献</h3>
 
 1. [JSR-133](https://jcp.org/en/jsr/detail?id=133)
 2. [Java Memory Model](http://www.cs.umd.edu/%7Epugh/java/memoryModel/)

[专题目录](http://wantedonline.cn/2016/09/08/20160908-1/)
